# This is a reusable workflow that can be called from your repository to provide an estimate given specific template/params
name: Estimate 

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Which GitHub Environment to use'
        required: false
        type: string
      rg:
        description: 'Resource Group name'
        required: true
        type: string
      aceVersion:
        description: 'Ace version tag'
        required: true
        type: choice
        default: 1.0.0-beta5
        options:
          - Latest
          - 1.0.0-beta5
        
  workflow_call:
    inputs:
      environment:
        description: 'Which GitHub Environment to use'
        required: false
        type: string
      rg:
        description: 'Resource Group name'
        required: true
        type: string
      aceVersion:
        description: 'Ace version tag'
        required: true
        default: 1.0.0-beta5
        type: string
#      templateParamFile:
#        description: 'Template parameters file'
#        required: false
#        type: string
#      templateParams:
#        description: 'Template parameters, space seperated key=value'
#        required: false
#        default: ''
#        type: string
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
    outputs:
      TotalCost:
        description: "The TotalCost"
        value: 0

permissions:
  id-token: write
  contents: read

concurrency: "${{ inputs.environment }}-${{ inputs.rg }}"

jobs:
  Estimate:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
    - uses: robinraju/release-downloader@v1.5
      name: Download Arm-Estimator release
      id: downloadACE
      with:
        repository: "TheCloudTheory/arm-estimator"
        latest: false
        tag: ${{ inputs.aceVersion }}
        fileName: "arm-estimator-linux-x64*.zip"
        #fileName: "arm-estimator-linux-x64-1.0.0-beta5.zip"
        
    - name: Unzip and prepare ACE
      run: |
        echo ${{steps.downloadACE.outputs.tag_name}}
        ACEZIP="arm-estimator-linux-x64-${{steps.downloadACE.outputs.tag_name}}.zip"
        echo $ACEZIP
        unzip $ACEZIP
        chmod +x ./arm-estimator

      # Login to Azure
    - uses: azure/login@v1.4.6
      name: Login to Azure
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        
    - name: Prepare/Check Arm Assets
      env:
        templateParams: ${{ inputs.templateParams}}
      run: |
        echo "Downloading arm template"
        curl -O https://github.com/Azure/AKS-Construction/releases/download/0.9.4/main.json -L

        echo "Downloading param file"
        curl -O https://raw.githubusercontent.com/Azure/AKS-Construction/main/.github/workflows_dep/AksDeploy-Private.parameters.json
        cat AksDeploy-Private.parameters.json
        
        ls -l
        
    - name: Estimate
      id: ace
      env:
        templateParams: ${{ inputs.templateParams}}
      run: |
        echo "Estimating"
        ./arm-estimator main.json ${{ secrets.AZURE_SUBSCRIPTION_ID }} ${{ inputs.rg }} --parameters AksDeploy-Private.parameters.json --disableDetailedMetrics --generateJsonOutput --jsonOutputFilename estimate.json

    - uses: actions/upload-artifact@v3.1.1
      with:
        name: estimate
        path: estimate.json
